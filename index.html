<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Badminton Game Scheduler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            background: #f9f9f9;
            padding: 10px;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            box-sizing: border-box;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }
        th {
            background: #333;
            color: white;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .performance {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üè∏ Scheduler</h1>
    <input type="text" id="playerNames" placeholder="Enter player names (comma separated)">
    <input type="number" id="numGames" placeholder="Number of games">
    <button onclick="generateSchedule()">Generate</button>
    <div id="idealGames"></div>
    <table id="scheduleTable">
        <thead>
        <tr><th>Game</th><th>Team 1</th><th>Team 2</th><th>Resting</th><th>Winner (1/2)</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="calculatePerformance()">Show Result</button>
    <div class="performance" id="performanceTable"></div>
</div>
<script>
let names = [], schedule = [], state = {}, performance = {};

function generateSchedule() {
    names = document.getElementById('playerNames').value.split(',').map(x => x.trim()).filter(x => x);
    const numGames = parseInt(document.getElementById('numGames').value);
    if (names.length < 6 || isNaN(numGames)) return alert('Minimum 6 players and valid number of games');

    const totalPairs = (names.length * (names.length - 1)) / 2;
    const ideal = Math.ceil(totalPairs / 2);
    document.getElementById('idealGames').innerHTML = `Ideal games for full pairing: <strong>${ideal}</strong>`;

    schedule = [];
    state = {};
    performance = {};
    names.forEach(n => {
        state[n] = { lastPlayed: [], games: 0 };
        performance[n] = { wins: 0, games: 0 };
    });

    for (let g = 0; g < numGames; g++) {
        let candidates = names.filter(p => {
            const recent = state[p].lastPlayed.slice(-2);
            const gamesInLast3 = state[p].lastPlayed.slice(-3);
            const played2inRow = recent.every(x => x === 'P');
            const rest2in3 = gamesInLast3.filter(x => x === 'R').length > 1;
            return !(played2inRow || rest2in3);
        });

        // Fallback: if not enough candidates, reset recent memory
        if (candidates.length < 4) candidates = names;

        // Shuffle candidates
        for (let i = candidates.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
        }

        const gamePlayers = candidates.slice(0, 4);
        const team1 = gamePlayers.slice(0, 2);
        const team2 = gamePlayers.slice(2, 4);
        const resting = names.filter(n => !gamePlayers.includes(n));

        schedule.push({ team1, team2, resting, winner: null });

        names.forEach(p => {
            if (gamePlayers.includes(p)) {
                state[p].lastPlayed.push('P');
                state[p].games++;
            } else {
                state[p].lastPlayed.push('R');
            }
        });
    }

    const tbody = document.querySelector('#scheduleTable tbody');
    tbody.innerHTML = '';
    schedule.forEach((g, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${g.team1.join(', ')}</td>
            <td>${g.team2.join(', ')}</td>
            <td>${g.resting.join(', ')}</td>
            <td><input type='number' min='1' max='2' onchange='setWinner(${i}, this.value)'></td>
        `;
        tbody.appendChild(tr);
    });
}

function setWinner(index, value) {
    const val = parseInt(value);
    if (val === 1 || val === 2) schedule[index].winner = val;
}

function calculatePerformance() {
    schedule.forEach(g => {
        if (!g.winner) return;
        const winTeam = g.winner === 1 ? g.team1 : g.team2;
        const all = [...g.team1, ...g.team2];
        all.forEach(p => performance[p].games++);
        winTeam.forEach(p => performance[p].wins++);
    });

    const sorted = Object.keys(performance).sort((a, b) => {
        const wa = performance[a];
        const wb = performance[b];
        const ra = wa.games ? wa.wins / wa.games : 0;
        const rb = wb.games ? wb.wins / wb.games : 0;
        return rb - ra;
    });

    let html = `<h3>üéØ Final Result</h3><table><tr><th>Player</th><th>Wins:Games</th><th>Win%</th></tr>`;
    sorted.forEach(p => {
        const { wins, games } = performance[p];
        const rate = games ? ((wins / games) * 100).toFixed(1) : '0.0';
        html += `<tr><td>${p}</td><td>${wins}:${games}</td><td>${rate}%</td></tr>`;
    });
    html += '</table>';
    document.getElementById('performanceTable').innerHTML = html;
}
</script>
</body>
</html>
